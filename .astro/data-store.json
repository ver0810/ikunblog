[["Map",1,2,7,8,169,170],"meta::meta",["Map",3,4,5,6],"astro-version","5.5.2","astro-config-digest","{\"root\":{},\"srcDir\":{},\"publicDir\":{},\"outDir\":{},\"cacheDir\":{},\"site\":\"https://ver0810.github.io\",\"compressHTML\":true,\"base\":\"/verblog/\",\"trailingSlash\":\"ignore\",\"output\":\"static\",\"scopedStyleStrategy\":\"attribute\",\"build\":{\"format\":\"directory\",\"client\":{},\"server\":{},\"assets\":\"_astro\",\"serverEntry\":\"entry.mjs\",\"redirects\":true,\"inlineStylesheets\":\"auto\",\"concurrency\":1},\"server\":{\"open\":false,\"host\":false,\"port\":4321,\"streaming\":true,\"allowedHosts\":[]},\"redirects\":{},\"image\":{\"endpoint\":{\"route\":\"/_image\"},\"service\":{\"entrypoint\":\"astro/assets/services/sharp\",\"config\":{}},\"domains\":[],\"remotePatterns\":[]},\"devToolbar\":{\"enabled\":true},\"markdown\":{\"syntaxHighlight\":{\"type\":\"shiki\",\"excludeLangs\":[\"math\"]},\"shikiConfig\":{\"langs\":[],\"langAlias\":{},\"theme\":\"catppuccin-frappe\",\"themes\":{},\"wrap\":false,\"transformers\":[]},\"remarkPlugins\":[[null,{\"types\":[\"note\",\"warning\",\"tip\",\"error\"]}],[null,null]],\"rehypePlugins\":[null],\"remarkRehype\":{},\"gfm\":true,\"smartypants\":true},\"security\":{\"checkOrigin\":true},\"env\":{\"schema\":{},\"validateSecrets\":false},\"experimental\":{\"clientPrerender\":false,\"contentIntellisense\":false,\"responsiveImages\":false,\"serializeConfig\":false,\"headingIdCompat\":false,\"preserveScriptOrder\":false},\"legacy\":{\"collections\":false}}","post",["Map",9,10,77,78,98,99,121,122],"transiportvisual",{"id":9,"data":11,"body":19,"filePath":20,"digest":21,"rendered":22,"legacyId":76},{"title":12,"publishDate":13,"description":14,"tags":15},"交通流量展示",["Date","2023-03-20T00:00:00.000Z"],"这是一个交通流量展示系统，用于深圳市的交通流量展示。",[16,17,18],"astro","blogging","learning in public","# 交通可视化系统技术栈文档\n\n## 1. 概述\n\n本文档详细记录了开发**深圳市交通**可视化系统所使用的技术栈。该系统主要用于展示深圳市的实时交通数据，并进行实时数据分析和预测。系统分为[前端和后端]两部分，前端负责数据展示和用户交互，后端负责数据处理和实时通信。\n\n## 2. 前端技术栈\n\n### 2.1 框架与语言\n- **React**: 用于构建用户界面的JavaScript库。React的组件化架构使得前端开发更加模块化和可维护。\n- **TypeScript (TS)**: JavaScript的超集，增加了静态类型检查，提高了代码的可读性和可维护性。\n- **Bun**: 一个快速的JavaScript运行时，用于构建和运行前端应用。Bun提供了更快的启动时间和更低的资源消耗。\n\n### 2.2 地图展示\n- **高德地图API**: 用于在系统中展示深圳市的地图，并实时展示交通数据。高德地图API提供了丰富的地图功能和数据接口，能够满足系统的需求。\n\n### 2.3 其他工具\n- **Webpack**: 用于模块打包和构建前端应用。\n- **ESLint**: 用于代码质量和风格检查，确保代码的一致性和可读性。\n- **Prettier**: 用于代码格式化，保持代码风格统一。\n\n## 3. 后端技术栈\n\n### 3.1 框架与语言\n- **FastAPI**: 一个现代、快速（高性能）的Web框架，用于构建API。FastAPI基于Python 3.7+，支持异步编程，能够高效处理大量并发请求。\n\n### 3.2 实时通信\n- **WebSocket**: 用于实现前后端之间的实时数据通信。WebSocket协议允许在单个TCP连接上进行全双工通信，适合实时数据传输。\n\n### 3.3 数据库\n- **MariaDB**: 用于存储和管理交通数据。MariaDB是一个功能强大的开源关系型数据库，兼容MySQL，支持复杂查询和数据完整性。\n\n### 3.4 其他工具\n- **Docker**: 用于容器化应用，简化部署和开发环境配置。\n- **Pydantic**: 用于数据验证和设置管理，确保数据的完整性和一致性。\n\n## 4. 系统架构\n\n### 4.1 前端架构\n前端采用React框架，通过高德地图API展示深圳市地图，并实时更新交通数据。前端与后端通过WebSocket进行实时通信，确保数据的实时性和准确性。\n\n### 4.2 后端架构\n后端采用FastAPI框架，提供RESTful API和WebSocket接口。后端通过WebSocket与前端进行实时数据通信，同时使用MariaDB存储交通数据。异步任务通过Celery处理，确保系统的性能和响应速度。\n\n## 5. 总结\n\n本系统通过使用React、TypeScript、Bun、FastAPI、WebSocket等技术栈，实现了深圳市交通数据的实时展示和分析预测。前端与后端通过WebSocket进行实时通信，确保数据的实时性和准确性。系统的架构设计合理，具有良好的可扩展性和可维护性。\n\n---","src/content/post/transiportvisual.md","f13e56a8de54e5cc",{"html":23,"metadata":24},"\u003Ch1 id=\"交通可视化系统技术栈文档\">交通可视化系统技术栈文档\u003C/h1>\n\u003Ch2 id=\"1-概述\">1. 概述\u003C/h2>\n\u003Cp>本文档详细记录了开发\u003Cstrong>深圳市交通\u003C/strong>可视化系统所使用的技术栈。该系统主要用于展示深圳市的实时交通数据，并进行实时数据分析和预测。系统分为[前端和后端]两部分，前端负责数据展示和用户交互，后端负责数据处理和实时通信。\u003C/p>\n\u003Ch2 id=\"2-前端技术栈\">2. 前端技术栈\u003C/h2>\n\u003Ch3 id=\"21-框架与语言\">2.1 框架与语言\u003C/h3>\n\u003Cul>\n\u003Cli>\u003Cstrong>React\u003C/strong>: 用于构建用户界面的JavaScript库。React的组件化架构使得前端开发更加模块化和可维护。\u003C/li>\n\u003Cli>\u003Cstrong>TypeScript (TS)\u003C/strong>: JavaScript的超集，增加了静态类型检查，提高了代码的可读性和可维护性。\u003C/li>\n\u003Cli>\u003Cstrong>Bun\u003C/strong>: 一个快速的JavaScript运行时，用于构建和运行前端应用。Bun提供了更快的启动时间和更低的资源消耗。\u003C/li>\n\u003C/ul>\n\u003Ch3 id=\"22-地图展示\">2.2 地图展示\u003C/h3>\n\u003Cul>\n\u003Cli>\u003Cstrong>高德地图API\u003C/strong>: 用于在系统中展示深圳市的地图，并实时展示交通数据。高德地图API提供了丰富的地图功能和数据接口，能够满足系统的需求。\u003C/li>\n\u003C/ul>\n\u003Ch3 id=\"23-其他工具\">2.3 其他工具\u003C/h3>\n\u003Cul>\n\u003Cli>\u003Cstrong>Webpack\u003C/strong>: 用于模块打包和构建前端应用。\u003C/li>\n\u003Cli>\u003Cstrong>ESLint\u003C/strong>: 用于代码质量和风格检查，确保代码的一致性和可读性。\u003C/li>\n\u003Cli>\u003Cstrong>Prettier\u003C/strong>: 用于代码格式化，保持代码风格统一。\u003C/li>\n\u003C/ul>\n\u003Ch2 id=\"3-后端技术栈\">3. 后端技术栈\u003C/h2>\n\u003Ch3 id=\"31-框架与语言\">3.1 框架与语言\u003C/h3>\n\u003Cul>\n\u003Cli>\u003Cstrong>FastAPI\u003C/strong>: 一个现代、快速（高性能）的Web框架，用于构建API。FastAPI基于Python 3.7+，支持异步编程，能够高效处理大量并发请求。\u003C/li>\n\u003C/ul>\n\u003Ch3 id=\"32-实时通信\">3.2 实时通信\u003C/h3>\n\u003Cul>\n\u003Cli>\u003Cstrong>WebSocket\u003C/strong>: 用于实现前后端之间的实时数据通信。WebSocket协议允许在单个TCP连接上进行全双工通信，适合实时数据传输。\u003C/li>\n\u003C/ul>\n\u003Ch3 id=\"33-数据库\">3.3 数据库\u003C/h3>\n\u003Cul>\n\u003Cli>\u003Cstrong>MariaDB\u003C/strong>: 用于存储和管理交通数据。MariaDB是一个功能强大的开源关系型数据库，兼容MySQL，支持复杂查询和数据完整性。\u003C/li>\n\u003C/ul>\n\u003Ch3 id=\"34-其他工具\">3.4 其他工具\u003C/h3>\n\u003Cul>\n\u003Cli>\u003Cstrong>Docker\u003C/strong>: 用于容器化应用，简化部署和开发环境配置。\u003C/li>\n\u003Cli>\u003Cstrong>Pydantic\u003C/strong>: 用于数据验证和设置管理，确保数据的完整性和一致性。\u003C/li>\n\u003C/ul>\n\u003Ch2 id=\"4-系统架构\">4. 系统架构\u003C/h2>\n\u003Ch3 id=\"41-前端架构\">4.1 前端架构\u003C/h3>\n\u003Cp>前端采用React框架，通过高德地图API展示深圳市地图，并实时更新交通数据。前端与后端通过WebSocket进行实时通信，确保数据的实时性和准确性。\u003C/p>\n\u003Ch3 id=\"42-后端架构\">4.2 后端架构\u003C/h3>\n\u003Cp>后端采用FastAPI框架，提供RESTful API和WebSocket接口。后端通过WebSocket与前端进行实时数据通信，同时使用MariaDB存储交通数据。异步任务通过Celery处理，确保系统的性能和响应速度。\u003C/p>\n\u003Ch2 id=\"5-总结\">5. 总结\u003C/h2>\n\u003Cp>本系统通过使用React、TypeScript、Bun、FastAPI、WebSocket等技术栈，实现了深圳市交通数据的实时展示和分析预测。前端与后端通过WebSocket进行实时通信，确保数据的实时性和准确性。系统的架构设计合理，具有良好的可扩展性和可维护性。\u003C/p>\n\u003Chr>",{"headings":25,"localImagePaths":73,"remoteImagePaths":74,"frontmatter":11,"imagePaths":75},[26,29,33,36,40,43,46,49,52,55,58,61,64,67,70],{"depth":27,"slug":28,"text":28},1,"交通可视化系统技术栈文档",{"depth":30,"slug":31,"text":32},2,"1-概述","1. 概述",{"depth":30,"slug":34,"text":35},"2-前端技术栈","2. 前端技术栈",{"depth":37,"slug":38,"text":39},3,"21-框架与语言","2.1 框架与语言",{"depth":37,"slug":41,"text":42},"22-地图展示","2.2 地图展示",{"depth":37,"slug":44,"text":45},"23-其他工具","2.3 其他工具",{"depth":30,"slug":47,"text":48},"3-后端技术栈","3. 后端技术栈",{"depth":37,"slug":50,"text":51},"31-框架与语言","3.1 框架与语言",{"depth":37,"slug":53,"text":54},"32-实时通信","3.2 实时通信",{"depth":37,"slug":56,"text":57},"33-数据库","3.3 数据库",{"depth":37,"slug":59,"text":60},"34-其他工具","3.4 其他工具",{"depth":30,"slug":62,"text":63},"4-系统架构","4. 系统架构",{"depth":37,"slug":65,"text":66},"41-前端架构","4.1 前端架构",{"depth":37,"slug":68,"text":69},"42-后端架构","4.2 后端架构",{"depth":30,"slug":71,"text":72},"5-总结","5. 总结",[],[],[],"transiportvisual.md","deepseek",{"id":77,"data":79,"body":84,"filePath":85,"digest":86,"rendered":87,"legacyId":97},{"title":80,"publishDate":81,"description":82,"tags":83},"deepseek is powerful",["Date","2022-07-01T00:00:00.000Z"],"deepseek 是一款强大的ai工具。",[16,17,18],"## Ai\n\ndeepseek 是一款强大的ai工具。\n\ndeepseek 使用MOE 专家架构。","src/content/post/deepseek.md","af8ed9ddc8bddb95",{"html":88,"metadata":89},"\u003Ch2 id=\"ai\">Ai\u003C/h2>\n\u003Cp>deepseek 是一款强大的ai工具。\u003C/p>\n\u003Cp>deepseek 使用MOE 专家架构。\u003C/p>",{"headings":90,"localImagePaths":94,"remoteImagePaths":95,"frontmatter":79,"imagePaths":96},[91],{"depth":30,"slug":92,"text":93},"ai","Ai",[],[],[],"deepseek.md","post-1",{"id":98,"data":100,"body":105,"filePath":106,"digest":107,"rendered":108,"legacyId":120},{"title":101,"publishDate":102,"description":103,"tags":104},"我的第一篇博客文章",["Date","2023-03-19T00:00:00.000Z"],"这是我 Astro 博客的第一篇文章。",[16,17,18],"## 我的第一篇博客文章\n\n欢迎来到我学习关于 Astro 的新博客！在这里，我将分享我建立新网站的学习历程。\n\n## 我做了什么\n\n1.  **安装 Astro**：首先，我创建了一个新的 Astro 项目并设置好了我的在线账号。\n\n2.  **制作页面**：然后我学习了如何通过创建新的 `.astro` 文件并将它们保存在 `src/pages/` 文件夹里来制作页面。\n\n3.  **发表博客文章**：这是我的第一篇博客文章！我现在有用 Astro 编写的页面和用 Markdown 写的文章了！\n\n## 下一步计划\n\n我将完成 Astro 教程，然后继续编写更多内容。关注我以获取更多信息。","src/content/post/post-1.md","325d31c5c68d73b6",{"html":109,"metadata":110},"\u003Ch2 id=\"我的第一篇博客文章\">我的第一篇博客文章\u003C/h2>\n\u003Cp>欢迎来到我学习关于 Astro 的新博客！在这里，我将分享我建立新网站的学习历程。\u003C/p>\n\u003Ch2 id=\"我做了什么\">我做了什么\u003C/h2>\n\u003Col>\n\u003Cli>\n\u003Cp>\u003Cstrong>安装 Astro\u003C/strong>：首先，我创建了一个新的 Astro 项目并设置好了我的在线账号。\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>\u003Cstrong>制作页面\u003C/strong>：然后我学习了如何通过创建新的 \u003Ccode>.astro\u003C/code> 文件并将它们保存在 \u003Ccode>src/pages/\u003C/code> 文件夹里来制作页面。\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>\u003Cstrong>发表博客文章\u003C/strong>：这是我的第一篇博客文章！我现在有用 Astro 编写的页面和用 Markdown 写的文章了！\u003C/p>\n\u003C/li>\n\u003C/ol>\n\u003Ch2 id=\"下一步计划\">下一步计划\u003C/h2>\n\u003Cp>我将完成 Astro 教程，然后继续编写更多内容。关注我以获取更多信息。\u003C/p>",{"headings":111,"localImagePaths":117,"remoteImagePaths":118,"frontmatter":100,"imagePaths":119},[112,113,115],{"depth":30,"slug":101,"text":101},{"depth":30,"slug":114,"text":114},"我做了什么",{"depth":30,"slug":116,"text":116},"下一步计划",[],[],[],"post-1.md","unsloth-fine-tune-deepseekqwen1-5b",{"id":121,"data":123,"body":130,"filePath":131,"digest":132,"rendered":133,"legacyId":168},{"title":124,"publishDate":125,"description":126,"tags":127},"使用unsloth加速训练deepseek-r1-distill-qwen-1.5b",["Date","2025-03-22T00:00:00.000Z"],"通过使用unsloth 库来实现在笔记本上监督微调deepseek模型",[128,77,129],"unsloth","train","## 安装所需要的库\n\n- **transformers** : 提供了可以轻松地下载并且训练先进的预训练模型的 API 和工具。\n- **unsloth** : 量化训练，减少显存消耗。\n- **wandb** : 可视化训练过程\n\n\n```python\n%pip install transformers unsloth wandb datasets accelerate\n```\n\n\n```python\nfrom datasets import load_dataset\nfrom transformers import Trainer, TrainingArguments\nfrom unsloth import FastLanguageModel\nimport wandb\nimport torch\n```\n\n配置wandb密钥。transformers会自动使用wandb进行实验跟踪。\n\n\n```python\nsecret_value_0 = \"f94dda6c6bae501b9220c25ecc5f530e90ac475a\"\n\nwandb.login(key=secret_value_0)\nrun = wandb.init(project=\"deepseek-fine-tune\", job_type=\"training\")\n```\n\n## 1. 加载数据集\n\n通过datasets库中的load_dataset函数加载数据集，指定名称之后，会自动从huggingface数据集中下载对应的数据集。\n\n你也可以使用自己的数据集：\n```\nraw_datasets = load_dataset(\"json\", data_files=\"./datasets/ppt_dataset_1.json\")\n\n```\n加载后的数据集对象是一个DatasetDict对象。\n\n\n```python\n# 加载数据集\n# raw_datasets = load_dataset(\"json\", data_files=\"./datasets/ppt_dataset_1.json\")\n\nraw_datasets = load_dataset(\"LooksJuicy/ruozhiba\")\n\n# 选取小型数据集\nsmall_datasets = raw_datasets[\"train\"].select(range(300))\n```\n\n## 2. 加载训练模型\n\n通过指定给定的模型名称会自动加载预训练模型。\n这里由于使用的Unsloth库，加载的是量化后的预训练模型。\n\n- max_seq_length = 2048– 控制上下文长度。虽然 Llama-3 支持 8192，但我们建议使用 2048 进行测试。Unsloth 可实现 4 倍更长的上下文微调。\n\n- dtype = None– 默认为无；使用torch.float16或torch.bfloat16适用于较新的 GPU。\n\n`load_in_4bit = True` – 启用 4 位量化，在 16GB GPU 上进行微调时，内存使用量减少 4 倍。在较大的 GPU（例如 H100）上禁用此功能可略微提高准确度（1-2%）。对于`完全微调`- 设置`full_finetuning = True` 和 8 位微调- 设置`load_in_8bit = True` 。\n\n\n```python\nmodel_name = \"deepseek-ai/DeepSeek-R1-Distill-Qwen-1.5B\"\nmax_seq_length = 512\n\n# 加载模型\nmodel, tokenizer = FastLanguageModel.from_pretrained(\n    model_name,\n    max_seq_length=max_seq_length,\n    load_in_4bit=True,\n    dtype=torch.float16,\n)\n```\n\nlora微调的配置。\n- r（分解等级）：控制微调过程。\n  - 建议： 8， 16， 32， 64， 128\n  - 更高：在困难任务上准确度更高，但会增加记忆力和过度拟合的风险。\n  - 较低：速度更快，节省内存，但可能会降低准确性。\n\n- lora_alpha（缩放因子）：决定学习强度\n  - 建议：等于或加倍等级（r）。\n  - 更高：学习更多，但可能过度拟合。\n  - 较低：学习速度较慢，更具普遍性。\n\n- lora_dropout（默认值：0）：正则化的 Dropout 概率。\n  - 更高：更多正规化，训练速度更慢。\n  - 较低（0）：训练速度更快，对过度拟合的影响最小。\n\n  \n- target_modules：需要微调的模块（默认包括\"q_proj\", \"k_proj\", \"v_proj\", \"o_proj\", \"gate_proj\", \"up_proj\", \"down_proj\"）。\n - 建议对所有模块进行微调以获得最佳效果。\n\n- use_gradient_checkpointing：减少长上下文的内存使用量。\n\n### 目标模块说明 \n这些组件将输入转换为注意力机制：\n**q_proj、k_proj、v_proj**：处理查询、键和值。\n**o_proj**：将注意力结果整合到模型中。\n**gate_proj**：管理门控层中的流程。\n**up_proj，down_proj**：调整维度以提高效率。\n\n\n```python\n# 定义 LoRA 配置, 将适配器附加到量化模型\nmodel = FastLanguageModel.get_peft_model(\n    model,\n    r=8,  # LoRA 秩\n    lora_alpha=16,  # LoRA alpha\n    target_modules=[\"q_proj\", \"v_proj\", \"gate_proj\", \"o_proj\"],\n    lora_dropout=0.1,  # LoRA dropout\n    bias=\"none\",  # Bias type\n    use_gradient_checkpointing=True,  # 梯度检查点（Unsloth优化版）\n    max_seq_length=max_seq_length,\n)\n```\n\n## 3. 分词处理\n\n1. 构建对话模板\n2. 预处理数据\n3. 对齐\n\n```\n### Instruction\n{}\n\n### Input\n{}\n\n### Response\n{}\n\n```\n\n\n```python\nif tokenizer.pad_token is None:\n    tokenizer.pad_token = tokenizer.eos_token  # 使用 eos_token 作为 pad_token\n\n\ndef tokenize_function(examples):\n    # 初始化容器\n    model_inputs = {\n        \"input_ids\": [],\n        \"attention_mask\": [],\n        \"labels\": [],\n    }\n\n    for ins, o in zip(examples[\"instruction\"], examples[\"output\"]):\n        # 构建完整对话结构\n        context = f\"[指令/问题]{ins} \\n[AI] \"\n        response = f\"{o}{tokenizer.pad_token}\"\n        full_text = context + response\n\n        # 统一分词（禁用自动添加特殊标记）\n        encoding = tokenizer(\n            full_text,\n            truncation=True,\n            max_length=512,\n            padding=\"max_length\" if tokenizer.pad_token else False,\n            # add_special_tokens=False,  # 关键！防止与模板中的特殊标记冲突\n        )\n\n        # 确定上下文长度（需要单独分词）\n        context_enc = tokenizer(context, add_special_tokens=False)\n        context_len = len(context_enc[\"input_ids\"])\n\n        # 创建标签（掩码输入部分）\n        labels = [\n            -100 if i \u003C context_len else token_id\n            for i, token_id in enumerate(encoding[\"input_ids\"])\n        ]\n\n        # 处理填充符的损失计算\n        labels = [\n            (l if l != tokenizer.pad_token_id else -100)\n            for l in labels\n        ]\n\n        # 存储结果\n        model_inputs[\"input_ids\"].append(encoding[\"input_ids\"])\n        model_inputs[\"attention_mask\"].append(encoding[\"attention_mask\"])\n        model_inputs[\"labels\"].append(labels)\n\n    return model_inputs\n```\n\n## 4. 应用分词并划分训练集和数据集\n\n\n```python\n# 应用分词函数\ntokenized_datasets = small_datasets.map(tokenize_function, batched=True)\n\n# 划分训练集与验证集\ntokenized_datasets = tokenized_datasets[\"train\"].train_test_split(test_size=0.1)\n```\n\n## 5. 配置训练超参数\n\n\n```python\n# 训练参数\ntraining_args = TrainingArguments(\n    output_dir=\"./results\",  # 模型保存路径\n    eval_strategy=\"steps\",  # 每轮验证\n    learning_rate=2e-5,  # 学习率\n    per_device_train_batch_size=2,  # 训练批量大小\n    per_device_eval_batch_size=8,  # 验证批量大小\n    gradient_accumulation_steps=2,\n    num_train_epochs=5,  # 训练轮数\n    weight_decay=0.01,  # 权重衰减\n    fp16=True,  # 混合精度训练（如果 GPU 支持）\n    logging_steps=20,\n    eval_steps=50,\n    save_steps=500,\n    load_best_model_at_end=True,\n    metric_for_best_model=\"eval_loss\",\n    greater_is_better=False,\n    report_to=\"wandb\",\n    lr_scheduler_type=\"cosine\",  # 学习率调度器\n    # optim=\"adamw_torch_fused\",\n)\n\n```\n\n## 6. 定义训练器\n\n\n```python\n# 训练\ntrainer = Trainer(\n    model=model,  # 模型\n    args=training_args,  # 训练参数\n    train_dataset=tokenized_datasets[\"train\"],  # 训练集\n    eval_dataset=tokenized_datasets[\"test\"],  # 验证集\n)\n```\n\n## 7. 开始训练\n\n\n```python\ntrainer.train()\nwandb.finish()\n```\n\n## 8. 保存训练模型\n\n\n```python\n# # 保存模型\nfrom peft import PeftModel\nfrom transformers import  AutoModelForCausalLM, AutoTokenizer\n\nmodel.save_pretrained(\"./lora_model/cprogram/12/\")\n\nmodel_name = \"deepseek-ai/DeepSeek-R1-Distill-Qwen-1.5B\"\n\nbase_model = AutoModelForCausalLM.from_pretrained(model_name, device_map=\"auto\")\nbase_tokenizer = AutoTokenizer.from_pretrained(model_name)\n\ntuned_model = PeftModel.from_pretrained(base_model, \"./lora_model/cprogram/12/\")\n\nmerge_model = tuned_model.merge_and_unload()\nmerge_model.save_pretrained(\"./tuned_merge_model/cprogram/12/\")\n\nmerge_model = AutoModelForCausalLM.from_pretrained(\n    \"./tuned_merge_model/cprogram/12/\", device_map=\"cuda\"\n)\n```","src/content/post/unsloth-fine-tune-deepseekqwen1-5b.md","e6f7fc7fc73097b4",{"html":134,"metadata":135},"\u003Ch2 id=\"安装所需要的库\">安装所需要的库\u003C/h2>\n\u003Cul>\n\u003Cli>\u003Cstrong>transformers\u003C/strong> : 提供了可以轻松地下载并且训练先进的预训练模型的 API 和工具。\u003C/li>\n\u003Cli>\u003Cstrong>unsloth\u003C/strong> : 量化训练，减少显存消耗。\u003C/li>\n\u003Cli>\u003Cstrong>wandb\u003C/strong> : 可视化训练过程\u003C/li>\n\u003C/ul>\n\u003Cpre class=\"astro-code catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#81C8BE\">%\u003C/span>\u003Cspan style=\"color:#C6D0F5\">pip install transformers unsloth wandb datasets accelerate\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cpre class=\"astro-code catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#CA9EE6\">from\u003C/span>\u003Cspan style=\"color:#C6D0F5\"> datasets \u003C/span>\u003Cspan style=\"color:#CA9EE6\">import\u003C/span>\u003Cspan style=\"color:#C6D0F5\"> load_dataset\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#CA9EE6\">from\u003C/span>\u003Cspan style=\"color:#C6D0F5\"> transformers \u003C/span>\u003Cspan style=\"color:#CA9EE6\">import\u003C/span>\u003Cspan style=\"color:#C6D0F5\"> Trainer\u003C/span>\u003Cspan style=\"color:#949CBB\">,\u003C/span>\u003Cspan style=\"color:#C6D0F5\"> TrainingArguments\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#CA9EE6\">from\u003C/span>\u003Cspan style=\"color:#C6D0F5\"> unsloth \u003C/span>\u003Cspan style=\"color:#CA9EE6\">import\u003C/span>\u003Cspan style=\"color:#C6D0F5\"> FastLanguageModel\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#CA9EE6\">import\u003C/span>\u003Cspan style=\"color:#C6D0F5\"> wandb\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#CA9EE6\">import\u003C/span>\u003Cspan style=\"color:#C6D0F5\"> torch\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>配置wandb密钥。transformers会自动使用wandb进行实验跟踪。\u003C/p>\n\u003Cpre class=\"astro-code catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#C6D0F5\">secret_value_0 \u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#A6D189\"> \"f94dda6c6bae501b9220c25ecc5f530e90ac475a\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#C6D0F5\">wandb\u003C/span>\u003Cspan style=\"color:#949CBB\">.\u003C/span>\u003Cspan style=\"color:#8CAAEE\">login\u003C/span>\u003Cspan style=\"color:#949CBB\">(\u003C/span>\u003Cspan style=\"color:#EA999C;font-style:italic\">key\u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#C6D0F5\">secret_value_0\u003C/span>\u003Cspan style=\"color:#949CBB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#C6D0F5\">run \u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#C6D0F5\"> wandb\u003C/span>\u003Cspan style=\"color:#949CBB\">.\u003C/span>\u003Cspan style=\"color:#8CAAEE\">init\u003C/span>\u003Cspan style=\"color:#949CBB\">(\u003C/span>\u003Cspan style=\"color:#EA999C;font-style:italic\">project\u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#A6D189\">\"deepseek-fine-tune\"\u003C/span>\u003Cspan style=\"color:#949CBB\">,\u003C/span>\u003Cspan style=\"color:#EA999C;font-style:italic\"> job_type\u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#A6D189\">\"training\"\u003C/span>\u003Cspan style=\"color:#949CBB\">)\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch2 id=\"1-加载数据集\">1. 加载数据集\u003C/h2>\n\u003Cp>通过datasets库中的load_dataset函数加载数据集，指定名称之后，会自动从huggingface数据集中下载对应的数据集。\u003C/p>\n\u003Cp>你也可以使用自己的数据集：\u003C/p>\n\u003Cpre class=\"astro-code catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5; overflow-x: auto;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>raw_datasets = load_dataset(\"json\", data_files=\"./datasets/ppt_dataset_1.json\")\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>加载后的数据集对象是一个DatasetDict对象。\u003C/p>\n\u003Cpre class=\"astro-code catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#737994;font-style:italic\"># 加载数据集\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#737994;font-style:italic\"># raw_datasets = load_dataset(\"json\", data_files=\"./datasets/ppt_dataset_1.json\")\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#C6D0F5\">raw_datasets \u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#8CAAEE\"> load_dataset\u003C/span>\u003Cspan style=\"color:#949CBB\">(\u003C/span>\u003Cspan style=\"color:#A6D189\">\"LooksJuicy/ruozhiba\"\u003C/span>\u003Cspan style=\"color:#949CBB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#737994;font-style:italic\"># 选取小型数据集\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#C6D0F5\">small_datasets \u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#EA999C;font-style:italic\"> raw_datasets\u003C/span>\u003Cspan style=\"color:#949CBB\">[\u003C/span>\u003Cspan style=\"color:#A6D189\">\"\u003C/span>\u003Cspan style=\"color:#A6D189;font-style:italic\">train\u003C/span>\u003Cspan style=\"color:#A6D189\">\"\u003C/span>\u003Cspan style=\"color:#949CBB\">].\u003C/span>\u003Cspan style=\"color:#8CAAEE\">select\u003C/span>\u003Cspan style=\"color:#949CBB\">(\u003C/span>\u003Cspan style=\"color:#EF9F76;font-style:italic\">range\u003C/span>\u003Cspan style=\"color:#949CBB\">(\u003C/span>\u003Cspan style=\"color:#EF9F76\">300\u003C/span>\u003Cspan style=\"color:#949CBB\">))\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch2 id=\"2-加载训练模型\">2. 加载训练模型\u003C/h2>\n\u003Cp>通过指定给定的模型名称会自动加载预训练模型。\n这里由于使用的Unsloth库，加载的是量化后的预训练模型。\u003C/p>\n\u003Cul>\n\u003Cli>\n\u003Cp>max_seq_length = 2048– 控制上下文长度。虽然 Llama-3 支持 8192，但我们建议使用 2048 进行测试。Unsloth 可实现 4 倍更长的上下文微调。\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>dtype = None– 默认为无；使用torch.float16或torch.bfloat16适用于较新的 GPU。\u003C/p>\n\u003C/li>\n\u003C/ul>\n\u003Cp>\u003Ccode>load_in_4bit = True\u003C/code> – 启用 4 位量化，在 16GB GPU 上进行微调时，内存使用量减少 4 倍。在较大的 GPU（例如 H100）上禁用此功能可略微提高准确度（1-2%）。对于\u003Ccode>完全微调\u003C/code>- 设置\u003Ccode>full_finetuning = True\u003C/code> 和 8 位微调- 设置\u003Ccode>load_in_8bit = True\u003C/code> 。\u003C/p>\n\u003Cpre class=\"astro-code catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#C6D0F5\">model_name \u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#A6D189\"> \"deepseek-ai/DeepSeek-R1-Distill-Qwen-1.5B\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#C6D0F5\">max_seq_length \u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#EF9F76\"> 512\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#737994;font-style:italic\"># 加载模型\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#C6D0F5\">model\u003C/span>\u003Cspan style=\"color:#949CBB\">,\u003C/span>\u003Cspan style=\"color:#C6D0F5\"> tokenizer \u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#C6D0F5\"> FastLanguageModel\u003C/span>\u003Cspan style=\"color:#949CBB\">.\u003C/span>\u003Cspan style=\"color:#8CAAEE\">from_pretrained\u003C/span>\u003Cspan style=\"color:#949CBB\">(\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#C6D0F5\">    model_name\u003C/span>\u003Cspan style=\"color:#949CBB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#EA999C;font-style:italic\">    max_seq_length\u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#C6D0F5\">max_seq_length\u003C/span>\u003Cspan style=\"color:#949CBB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#EA999C;font-style:italic\">    load_in_4bit\u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#CA9EE6\">True\u003C/span>\u003Cspan style=\"color:#949CBB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#EA999C;font-style:italic\">    dtype\u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#C6D0F5\">torch\u003C/span>\u003Cspan style=\"color:#949CBB\">.\u003C/span>\u003Cspan style=\"color:#C6D0F5\">float16\u003C/span>\u003Cspan style=\"color:#949CBB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#949CBB\">)\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>lora微调的配置。\u003C/p>\n\u003Cul>\n\u003Cli>\n\u003Cp>r（分解等级）：控制微调过程。\u003C/p>\n\u003Cul>\n\u003Cli>建议： 8， 16， 32， 64， 128\u003C/li>\n\u003Cli>更高：在困难任务上准确度更高，但会增加记忆力和过度拟合的风险。\u003C/li>\n\u003Cli>较低：速度更快，节省内存，但可能会降低准确性。\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003Cli>\n\u003Cp>lora_alpha（缩放因子）：决定学习强度\u003C/p>\n\u003Cul>\n\u003Cli>建议：等于或加倍等级（r）。\u003C/li>\n\u003Cli>更高：学习更多，但可能过度拟合。\u003C/li>\n\u003Cli>较低：学习速度较慢，更具普遍性。\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003Cli>\n\u003Cp>lora_dropout（默认值：0）：正则化的 Dropout 概率。\u003C/p>\n\u003Cul>\n\u003Cli>更高：更多正规化，训练速度更慢。\u003C/li>\n\u003Cli>较低（0）：训练速度更快，对过度拟合的影响最小。\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003Cli>\n\u003Cp>target_modules：需要微调的模块（默认包括”q_proj”, “k_proj”, “v_proj”, “o_proj”, “gate_proj”, “up_proj”, “down_proj”）。\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>建议对所有模块进行微调以获得最佳效果。\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>use_gradient_checkpointing：减少长上下文的内存使用量。\u003C/p>\n\u003C/li>\n\u003C/ul>\n\u003Ch3 id=\"目标模块说明\">目标模块说明\u003C/h3>\n\u003Cp>这些组件将输入转换为注意力机制：\n\u003Cstrong>q_proj、k_proj、v_proj\u003C/strong>：处理查询、键和值。\n\u003Cstrong>o_proj\u003C/strong>：将注意力结果整合到模型中。\n\u003Cstrong>gate_proj\u003C/strong>：管理门控层中的流程。\n\u003Cstrong>up_proj，down_proj\u003C/strong>：调整维度以提高效率。\u003C/p>\n\u003Cpre class=\"astro-code catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#737994;font-style:italic\"># 定义 LoRA 配置, 将适配器附加到量化模型\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#C6D0F5\">model \u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#C6D0F5\"> FastLanguageModel\u003C/span>\u003Cspan style=\"color:#949CBB\">.\u003C/span>\u003Cspan style=\"color:#8CAAEE\">get_peft_model\u003C/span>\u003Cspan style=\"color:#949CBB\">(\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#C6D0F5\">    model\u003C/span>\u003Cspan style=\"color:#949CBB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#EA999C;font-style:italic\">    r\u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#EF9F76\">8\u003C/span>\u003Cspan style=\"color:#949CBB\">,\u003C/span>\u003Cspan style=\"color:#737994;font-style:italic\">  # LoRA 秩\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#EA999C;font-style:italic\">    lora_alpha\u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#EF9F76\">16\u003C/span>\u003Cspan style=\"color:#949CBB\">,\u003C/span>\u003Cspan style=\"color:#737994;font-style:italic\">  # LoRA alpha\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#EA999C;font-style:italic\">    target_modules\u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#949CBB\">[\u003C/span>\u003Cspan style=\"color:#A6D189\">\"q_proj\"\u003C/span>\u003Cspan style=\"color:#949CBB\">,\u003C/span>\u003Cspan style=\"color:#A6D189\"> \"v_proj\"\u003C/span>\u003Cspan style=\"color:#949CBB\">,\u003C/span>\u003Cspan style=\"color:#A6D189\"> \"gate_proj\"\u003C/span>\u003Cspan style=\"color:#949CBB\">,\u003C/span>\u003Cspan style=\"color:#A6D189\"> \"o_proj\"\u003C/span>\u003Cspan style=\"color:#949CBB\">],\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#EA999C;font-style:italic\">    lora_dropout\u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#EF9F76\">0.1\u003C/span>\u003Cspan style=\"color:#949CBB\">,\u003C/span>\u003Cspan style=\"color:#737994;font-style:italic\">  # LoRA dropout\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#EA999C;font-style:italic\">    bias\u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#A6D189\">\"none\"\u003C/span>\u003Cspan style=\"color:#949CBB\">,\u003C/span>\u003Cspan style=\"color:#737994;font-style:italic\">  # Bias type\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#EA999C;font-style:italic\">    use_gradient_checkpointing\u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#CA9EE6\">True\u003C/span>\u003Cspan style=\"color:#949CBB\">,\u003C/span>\u003Cspan style=\"color:#737994;font-style:italic\">  # 梯度检查点（Unsloth优化版）\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#EA999C;font-style:italic\">    max_seq_length\u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#C6D0F5\">max_seq_length\u003C/span>\u003Cspan style=\"color:#949CBB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#949CBB\">)\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch2 id=\"3-分词处理\">3. 分词处理\u003C/h2>\n\u003Col>\n\u003Cli>构建对话模板\u003C/li>\n\u003Cli>预处理数据\u003C/li>\n\u003Cli>对齐\u003C/li>\n\u003C/ol>\n\u003Cpre class=\"astro-code catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5; overflow-x: auto;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>### Instruction\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>{}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>### Input\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>{}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>### Response\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>{}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cpre class=\"astro-code catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#CA9EE6\">if\u003C/span>\u003Cspan style=\"color:#C6D0F5\"> tokenizer\u003C/span>\u003Cspan style=\"color:#949CBB\">.\u003C/span>\u003Cspan style=\"color:#C6D0F5\">pad_token \u003C/span>\u003Cspan style=\"color:#CA9EE6\">is\u003C/span>\u003Cspan style=\"color:#CA9EE6\"> None\u003C/span>\u003Cspan style=\"color:#949CBB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#C6D0F5\">    tokenizer\u003C/span>\u003Cspan style=\"color:#949CBB\">.\u003C/span>\u003Cspan style=\"color:#C6D0F5\">pad_token \u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#C6D0F5\"> tokenizer\u003C/span>\u003Cspan style=\"color:#949CBB\">.\u003C/span>\u003Cspan style=\"color:#C6D0F5\">eos_token  \u003C/span>\u003Cspan style=\"color:#737994;font-style:italic\"># 使用 eos_token 作为 pad_token\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#CA9EE6\">def\u003C/span>\u003Cspan style=\"color:#8CAAEE;font-style:italic\"> tokenize_function\u003C/span>\u003Cspan style=\"color:#949CBB\">(\u003C/span>\u003Cspan style=\"color:#EA999C;font-style:italic\">examples\u003C/span>\u003Cspan style=\"color:#949CBB\">):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#737994;font-style:italic\">    # 初始化容器\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#C6D0F5\">    model_inputs \u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#949CBB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#A6D189\">        \"input_ids\"\u003C/span>\u003Cspan style=\"color:#949CBB\">:\u003C/span>\u003Cspan style=\"color:#949CBB\"> [],\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#A6D189\">        \"attention_mask\"\u003C/span>\u003Cspan style=\"color:#949CBB\">:\u003C/span>\u003Cspan style=\"color:#949CBB\"> [],\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#A6D189\">        \"labels\"\u003C/span>\u003Cspan style=\"color:#949CBB\">:\u003C/span>\u003Cspan style=\"color:#949CBB\"> [],\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#949CBB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#CA9EE6\">    for\u003C/span>\u003Cspan style=\"color:#C6D0F5\"> ins\u003C/span>\u003Cspan style=\"color:#949CBB\">,\u003C/span>\u003Cspan style=\"color:#C6D0F5\"> o \u003C/span>\u003Cspan style=\"color:#CA9EE6\">in\u003C/span>\u003Cspan style=\"color:#EF9F76;font-style:italic\"> zip\u003C/span>\u003Cspan style=\"color:#949CBB\">(\u003C/span>\u003Cspan style=\"color:#EA999C;font-style:italic\">examples\u003C/span>\u003Cspan style=\"color:#949CBB\">[\u003C/span>\u003Cspan style=\"color:#A6D189\">\"\u003C/span>\u003Cspan style=\"color:#A6D189;font-style:italic\">instruction\u003C/span>\u003Cspan style=\"color:#A6D189\">\"\u003C/span>\u003Cspan style=\"color:#949CBB\">],\u003C/span>\u003Cspan style=\"color:#EA999C;font-style:italic\"> examples\u003C/span>\u003Cspan style=\"color:#949CBB\">[\u003C/span>\u003Cspan style=\"color:#A6D189\">\"\u003C/span>\u003Cspan style=\"color:#A6D189;font-style:italic\">output\u003C/span>\u003Cspan style=\"color:#A6D189\">\"\u003C/span>\u003Cspan style=\"color:#949CBB\">]):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#737994;font-style:italic\">        # 构建完整对话结构\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#C6D0F5\">        context \u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#A6D189;font-style:italic\"> f\u003C/span>\u003Cspan style=\"color:#A6D189\">\"[指令/问题]\u003C/span>\u003Cspan style=\"color:#F4B8E4\">{\u003C/span>\u003Cspan style=\"color:#C6D0F5\">ins\u003C/span>\u003Cspan style=\"color:#F4B8E4\">}\u003C/span>\u003Cspan style=\"color:#F4B8E4\"> \\n\u003C/span>\u003Cspan style=\"color:#A6D189\">[AI] \"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#C6D0F5\">        response \u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#A6D189;font-style:italic\"> f\u003C/span>\u003Cspan style=\"color:#A6D189\">\"\u003C/span>\u003Cspan style=\"color:#F4B8E4\">{\u003C/span>\u003Cspan style=\"color:#C6D0F5\">o\u003C/span>\u003Cspan style=\"color:#F4B8E4\">}{\u003C/span>\u003Cspan style=\"color:#C6D0F5\">tokenizer\u003C/span>\u003Cspan style=\"color:#949CBB\">.\u003C/span>\u003Cspan style=\"color:#C6D0F5\">pad_token\u003C/span>\u003Cspan style=\"color:#F4B8E4\">}\u003C/span>\u003Cspan style=\"color:#A6D189\">\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#C6D0F5\">        full_text \u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#C6D0F5\"> context \u003C/span>\u003Cspan style=\"color:#81C8BE\">+\u003C/span>\u003Cspan style=\"color:#C6D0F5\"> response\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#737994;font-style:italic\">        # 统一分词（禁用自动添加特殊标记）\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#C6D0F5\">        encoding \u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#8CAAEE\"> tokenizer\u003C/span>\u003Cspan style=\"color:#949CBB\">(\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#C6D0F5\">            full_text\u003C/span>\u003Cspan style=\"color:#949CBB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#EA999C;font-style:italic\">            truncation\u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#CA9EE6\">True\u003C/span>\u003Cspan style=\"color:#949CBB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#EA999C;font-style:italic\">            max_length\u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#EF9F76\">512\u003C/span>\u003Cspan style=\"color:#949CBB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#EA999C;font-style:italic\">            padding\u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#A6D189\">\"max_length\"\u003C/span>\u003Cspan style=\"color:#CA9EE6\"> if\u003C/span>\u003Cspan style=\"color:#C6D0F5\"> tokenizer\u003C/span>\u003Cspan style=\"color:#949CBB\">.\u003C/span>\u003Cspan style=\"color:#C6D0F5\">pad_token \u003C/span>\u003Cspan style=\"color:#CA9EE6\">else\u003C/span>\u003Cspan style=\"color:#CA9EE6\"> False\u003C/span>\u003Cspan style=\"color:#949CBB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#737994;font-style:italic\">            # add_special_tokens=False,  # 关键！防止与模板中的特殊标记冲突\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#949CBB\">        )\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#737994;font-style:italic\">        # 确定上下文长度（需要单独分词）\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#C6D0F5\">        context_enc \u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#8CAAEE\"> tokenizer\u003C/span>\u003Cspan style=\"color:#949CBB\">(\u003C/span>\u003Cspan style=\"color:#C6D0F5\">context\u003C/span>\u003Cspan style=\"color:#949CBB\">,\u003C/span>\u003Cspan style=\"color:#EA999C;font-style:italic\"> add_special_tokens\u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#CA9EE6\">False\u003C/span>\u003Cspan style=\"color:#949CBB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#C6D0F5\">        context_len \u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#EF9F76;font-style:italic\"> len\u003C/span>\u003Cspan style=\"color:#949CBB\">(\u003C/span>\u003Cspan style=\"color:#EA999C;font-style:italic\">context_enc\u003C/span>\u003Cspan style=\"color:#949CBB\">[\u003C/span>\u003Cspan style=\"color:#A6D189\">\"\u003C/span>\u003Cspan style=\"color:#A6D189;font-style:italic\">input_ids\u003C/span>\u003Cspan style=\"color:#A6D189\">\"\u003C/span>\u003Cspan style=\"color:#949CBB\">])\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#737994;font-style:italic\">        # 创建标签（掩码输入部分）\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#C6D0F5\">        labels \u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#949CBB\"> [\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#81C8BE\">            -\u003C/span>\u003Cspan style=\"color:#EF9F76\">100\u003C/span>\u003Cspan style=\"color:#CA9EE6\"> if\u003C/span>\u003Cspan style=\"color:#C6D0F5\"> i \u003C/span>\u003Cspan style=\"color:#81C8BE\">&#x3C;\u003C/span>\u003Cspan style=\"color:#C6D0F5\"> context_len \u003C/span>\u003Cspan style=\"color:#CA9EE6\">else\u003C/span>\u003Cspan style=\"color:#C6D0F5\"> token_id\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#CA9EE6\">            for\u003C/span>\u003Cspan style=\"color:#C6D0F5\"> i\u003C/span>\u003Cspan style=\"color:#949CBB\">,\u003C/span>\u003Cspan style=\"color:#C6D0F5\"> token_id \u003C/span>\u003Cspan style=\"color:#CA9EE6\">in\u003C/span>\u003Cspan style=\"color:#EF9F76;font-style:italic\"> enumerate\u003C/span>\u003Cspan style=\"color:#949CBB\">(\u003C/span>\u003Cspan style=\"color:#EA999C;font-style:italic\">encoding\u003C/span>\u003Cspan style=\"color:#949CBB\">[\u003C/span>\u003Cspan style=\"color:#A6D189\">\"\u003C/span>\u003Cspan style=\"color:#A6D189;font-style:italic\">input_ids\u003C/span>\u003Cspan style=\"color:#A6D189\">\"\u003C/span>\u003Cspan style=\"color:#949CBB\">])\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#949CBB\">        ]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#737994;font-style:italic\">        # 处理填充符的损失计算\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#C6D0F5\">        labels \u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#949CBB\"> [\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#949CBB\">            (\u003C/span>\u003Cspan style=\"color:#C6D0F5\">l \u003C/span>\u003Cspan style=\"color:#CA9EE6\">if\u003C/span>\u003Cspan style=\"color:#C6D0F5\"> l \u003C/span>\u003Cspan style=\"color:#81C8BE\">!=\u003C/span>\u003Cspan style=\"color:#C6D0F5\"> tokenizer\u003C/span>\u003Cspan style=\"color:#949CBB\">.\u003C/span>\u003Cspan style=\"color:#C6D0F5\">pad_token_id \u003C/span>\u003Cspan style=\"color:#CA9EE6\">else\u003C/span>\u003Cspan style=\"color:#81C8BE\"> -\u003C/span>\u003Cspan style=\"color:#EF9F76\">100\u003C/span>\u003Cspan style=\"color:#949CBB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#CA9EE6\">            for\u003C/span>\u003Cspan style=\"color:#C6D0F5\"> l \u003C/span>\u003Cspan style=\"color:#CA9EE6\">in\u003C/span>\u003Cspan style=\"color:#C6D0F5\"> labels\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#949CBB\">        ]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#737994;font-style:italic\">        # 存储结果\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#EA999C;font-style:italic\">        model_inputs\u003C/span>\u003Cspan style=\"color:#949CBB\">[\u003C/span>\u003Cspan style=\"color:#A6D189\">\"\u003C/span>\u003Cspan style=\"color:#A6D189;font-style:italic\">input_ids\u003C/span>\u003Cspan style=\"color:#A6D189\">\"\u003C/span>\u003Cspan style=\"color:#949CBB\">].\u003C/span>\u003Cspan style=\"color:#8CAAEE\">append\u003C/span>\u003Cspan style=\"color:#949CBB\">(\u003C/span>\u003Cspan style=\"color:#EA999C;font-style:italic\">encoding\u003C/span>\u003Cspan style=\"color:#949CBB\">[\u003C/span>\u003Cspan style=\"color:#A6D189\">\"\u003C/span>\u003Cspan style=\"color:#A6D189;font-style:italic\">input_ids\u003C/span>\u003Cspan style=\"color:#A6D189\">\"\u003C/span>\u003Cspan style=\"color:#949CBB\">])\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#EA999C;font-style:italic\">        model_inputs\u003C/span>\u003Cspan style=\"color:#949CBB\">[\u003C/span>\u003Cspan style=\"color:#A6D189\">\"\u003C/span>\u003Cspan style=\"color:#A6D189;font-style:italic\">attention_mask\u003C/span>\u003Cspan style=\"color:#A6D189\">\"\u003C/span>\u003Cspan style=\"color:#949CBB\">].\u003C/span>\u003Cspan style=\"color:#8CAAEE\">append\u003C/span>\u003Cspan style=\"color:#949CBB\">(\u003C/span>\u003Cspan style=\"color:#EA999C;font-style:italic\">encoding\u003C/span>\u003Cspan style=\"color:#949CBB\">[\u003C/span>\u003Cspan style=\"color:#A6D189\">\"\u003C/span>\u003Cspan style=\"color:#A6D189;font-style:italic\">attention_mask\u003C/span>\u003Cspan style=\"color:#A6D189\">\"\u003C/span>\u003Cspan style=\"color:#949CBB\">])\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#EA999C;font-style:italic\">        model_inputs\u003C/span>\u003Cspan style=\"color:#949CBB\">[\u003C/span>\u003Cspan style=\"color:#A6D189\">\"\u003C/span>\u003Cspan style=\"color:#A6D189;font-style:italic\">labels\u003C/span>\u003Cspan style=\"color:#A6D189\">\"\u003C/span>\u003Cspan style=\"color:#949CBB\">].\u003C/span>\u003Cspan style=\"color:#8CAAEE\">append\u003C/span>\u003Cspan style=\"color:#949CBB\">(\u003C/span>\u003Cspan style=\"color:#C6D0F5\">labels\u003C/span>\u003Cspan style=\"color:#949CBB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#CA9EE6\">    return\u003C/span>\u003Cspan style=\"color:#C6D0F5\"> model_inputs\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch2 id=\"4-应用分词并划分训练集和数据集\">4. 应用分词并划分训练集和数据集\u003C/h2>\n\u003Cpre class=\"astro-code catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#737994;font-style:italic\"># 应用分词函数\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#C6D0F5\">tokenized_datasets \u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#C6D0F5\"> small_datasets\u003C/span>\u003Cspan style=\"color:#949CBB\">.\u003C/span>\u003Cspan style=\"color:#8CAAEE\">map\u003C/span>\u003Cspan style=\"color:#949CBB\">(\u003C/span>\u003Cspan style=\"color:#C6D0F5\">tokenize_function\u003C/span>\u003Cspan style=\"color:#949CBB\">,\u003C/span>\u003Cspan style=\"color:#EA999C;font-style:italic\"> batched\u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#CA9EE6\">True\u003C/span>\u003Cspan style=\"color:#949CBB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#737994;font-style:italic\"># 划分训练集与验证集\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#C6D0F5\">tokenized_datasets \u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#EA999C;font-style:italic\"> tokenized_datasets\u003C/span>\u003Cspan style=\"color:#949CBB\">[\u003C/span>\u003Cspan style=\"color:#A6D189\">\"\u003C/span>\u003Cspan style=\"color:#A6D189;font-style:italic\">train\u003C/span>\u003Cspan style=\"color:#A6D189\">\"\u003C/span>\u003Cspan style=\"color:#949CBB\">].\u003C/span>\u003Cspan style=\"color:#8CAAEE\">train_test_split\u003C/span>\u003Cspan style=\"color:#949CBB\">(\u003C/span>\u003Cspan style=\"color:#EA999C;font-style:italic\">test_size\u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#EF9F76\">0.1\u003C/span>\u003Cspan style=\"color:#949CBB\">)\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch2 id=\"5-配置训练超参数\">5. 配置训练超参数\u003C/h2>\n\u003Cpre class=\"astro-code catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#737994;font-style:italic\"># 训练参数\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#C6D0F5\">training_args \u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#8CAAEE\"> TrainingArguments\u003C/span>\u003Cspan style=\"color:#949CBB\">(\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#EA999C;font-style:italic\">    output_dir\u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#A6D189\">\"./results\"\u003C/span>\u003Cspan style=\"color:#949CBB\">,\u003C/span>\u003Cspan style=\"color:#737994;font-style:italic\">  # 模型保存路径\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#EA999C;font-style:italic\">    eval_strategy\u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#A6D189\">\"steps\"\u003C/span>\u003Cspan style=\"color:#949CBB\">,\u003C/span>\u003Cspan style=\"color:#737994;font-style:italic\">  # 每轮验证\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#EA999C;font-style:italic\">    learning_rate\u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#EF9F76\">2e-5\u003C/span>\u003Cspan style=\"color:#949CBB\">,\u003C/span>\u003Cspan style=\"color:#737994;font-style:italic\">  # 学习率\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#EA999C;font-style:italic\">    per_device_train_batch_size\u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#EF9F76\">2\u003C/span>\u003Cspan style=\"color:#949CBB\">,\u003C/span>\u003Cspan style=\"color:#737994;font-style:italic\">  # 训练批量大小\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#EA999C;font-style:italic\">    per_device_eval_batch_size\u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#EF9F76\">8\u003C/span>\u003Cspan style=\"color:#949CBB\">,\u003C/span>\u003Cspan style=\"color:#737994;font-style:italic\">  # 验证批量大小\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#EA999C;font-style:italic\">    gradient_accumulation_steps\u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#EF9F76\">2\u003C/span>\u003Cspan style=\"color:#949CBB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#EA999C;font-style:italic\">    num_train_epochs\u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#EF9F76\">5\u003C/span>\u003Cspan style=\"color:#949CBB\">,\u003C/span>\u003Cspan style=\"color:#737994;font-style:italic\">  # 训练轮数\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#EA999C;font-style:italic\">    weight_decay\u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#EF9F76\">0.01\u003C/span>\u003Cspan style=\"color:#949CBB\">,\u003C/span>\u003Cspan style=\"color:#737994;font-style:italic\">  # 权重衰减\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#EA999C;font-style:italic\">    fp16\u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#CA9EE6\">True\u003C/span>\u003Cspan style=\"color:#949CBB\">,\u003C/span>\u003Cspan style=\"color:#737994;font-style:italic\">  # 混合精度训练（如果 GPU 支持）\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#EA999C;font-style:italic\">    logging_steps\u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#EF9F76\">20\u003C/span>\u003Cspan style=\"color:#949CBB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#EA999C;font-style:italic\">    eval_steps\u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#EF9F76\">50\u003C/span>\u003Cspan style=\"color:#949CBB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#EA999C;font-style:italic\">    save_steps\u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#EF9F76\">500\u003C/span>\u003Cspan style=\"color:#949CBB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#EA999C;font-style:italic\">    load_best_model_at_end\u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#CA9EE6\">True\u003C/span>\u003Cspan style=\"color:#949CBB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#EA999C;font-style:italic\">    metric_for_best_model\u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#A6D189\">\"eval_loss\"\u003C/span>\u003Cspan style=\"color:#949CBB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#EA999C;font-style:italic\">    greater_is_better\u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#CA9EE6\">False\u003C/span>\u003Cspan style=\"color:#949CBB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#EA999C;font-style:italic\">    report_to\u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#A6D189\">\"wandb\"\u003C/span>\u003Cspan style=\"color:#949CBB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#EA999C;font-style:italic\">    lr_scheduler_type\u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#A6D189\">\"cosine\"\u003C/span>\u003Cspan style=\"color:#949CBB\">,\u003C/span>\u003Cspan style=\"color:#737994;font-style:italic\">  # 学习率调度器\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#737994;font-style:italic\">    # optim=\"adamw_torch_fused\",\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#949CBB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch2 id=\"6-定义训练器\">6. 定义训练器\u003C/h2>\n\u003Cpre class=\"astro-code catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#737994;font-style:italic\"># 训练\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#C6D0F5\">trainer \u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#8CAAEE\"> Trainer\u003C/span>\u003Cspan style=\"color:#949CBB\">(\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#EA999C;font-style:italic\">    model\u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#C6D0F5\">model\u003C/span>\u003Cspan style=\"color:#949CBB\">,\u003C/span>\u003Cspan style=\"color:#737994;font-style:italic\">  # 模型\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#EA999C;font-style:italic\">    args\u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#C6D0F5\">training_args\u003C/span>\u003Cspan style=\"color:#949CBB\">,\u003C/span>\u003Cspan style=\"color:#737994;font-style:italic\">  # 训练参数\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#EA999C;font-style:italic\">    train_dataset\u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#EA999C;font-style:italic\">tokenized_datasets\u003C/span>\u003Cspan style=\"color:#949CBB\">[\u003C/span>\u003Cspan style=\"color:#A6D189\">\"\u003C/span>\u003Cspan style=\"color:#A6D189;font-style:italic\">train\u003C/span>\u003Cspan style=\"color:#A6D189\">\"\u003C/span>\u003Cspan style=\"color:#949CBB\">],\u003C/span>\u003Cspan style=\"color:#737994;font-style:italic\">  # 训练集\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#EA999C;font-style:italic\">    eval_dataset\u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#EA999C;font-style:italic\">tokenized_datasets\u003C/span>\u003Cspan style=\"color:#949CBB\">[\u003C/span>\u003Cspan style=\"color:#A6D189\">\"\u003C/span>\u003Cspan style=\"color:#A6D189;font-style:italic\">test\u003C/span>\u003Cspan style=\"color:#A6D189\">\"\u003C/span>\u003Cspan style=\"color:#949CBB\">],\u003C/span>\u003Cspan style=\"color:#737994;font-style:italic\">  # 验证集\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#949CBB\">)\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch2 id=\"7-开始训练\">7. 开始训练\u003C/h2>\n\u003Cpre class=\"astro-code catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#C6D0F5\">trainer\u003C/span>\u003Cspan style=\"color:#949CBB\">.\u003C/span>\u003Cspan style=\"color:#8CAAEE\">train\u003C/span>\u003Cspan style=\"color:#949CBB\">()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#C6D0F5\">wandb\u003C/span>\u003Cspan style=\"color:#949CBB\">.\u003C/span>\u003Cspan style=\"color:#8CAAEE\">finish\u003C/span>\u003Cspan style=\"color:#949CBB\">()\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch2 id=\"8-保存训练模型\">8. 保存训练模型\u003C/h2>\n\u003Cpre class=\"astro-code catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#737994;font-style:italic\"># # 保存模型\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#CA9EE6\">from\u003C/span>\u003Cspan style=\"color:#C6D0F5\"> peft \u003C/span>\u003Cspan style=\"color:#CA9EE6\">import\u003C/span>\u003Cspan style=\"color:#C6D0F5\"> PeftModel\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#CA9EE6\">from\u003C/span>\u003Cspan style=\"color:#C6D0F5\"> transformers \u003C/span>\u003Cspan style=\"color:#CA9EE6\">import\u003C/span>\u003Cspan style=\"color:#C6D0F5\">  AutoModelForCausalLM\u003C/span>\u003Cspan style=\"color:#949CBB\">,\u003C/span>\u003Cspan style=\"color:#C6D0F5\"> AutoTokenizer\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#C6D0F5\">model\u003C/span>\u003Cspan style=\"color:#949CBB\">.\u003C/span>\u003Cspan style=\"color:#8CAAEE\">save_pretrained\u003C/span>\u003Cspan style=\"color:#949CBB\">(\u003C/span>\u003Cspan style=\"color:#A6D189\">\"./lora_model/cprogram/12/\"\u003C/span>\u003Cspan style=\"color:#949CBB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#C6D0F5\">model_name \u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#A6D189\"> \"deepseek-ai/DeepSeek-R1-Distill-Qwen-1.5B\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#C6D0F5\">base_model \u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#C6D0F5\"> AutoModelForCausalLM\u003C/span>\u003Cspan style=\"color:#949CBB\">.\u003C/span>\u003Cspan style=\"color:#8CAAEE\">from_pretrained\u003C/span>\u003Cspan style=\"color:#949CBB\">(\u003C/span>\u003Cspan style=\"color:#C6D0F5\">model_name\u003C/span>\u003Cspan style=\"color:#949CBB\">,\u003C/span>\u003Cspan style=\"color:#EA999C;font-style:italic\"> device_map\u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#A6D189\">\"auto\"\u003C/span>\u003Cspan style=\"color:#949CBB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#C6D0F5\">base_tokenizer \u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#C6D0F5\"> AutoTokenizer\u003C/span>\u003Cspan style=\"color:#949CBB\">.\u003C/span>\u003Cspan style=\"color:#8CAAEE\">from_pretrained\u003C/span>\u003Cspan style=\"color:#949CBB\">(\u003C/span>\u003Cspan style=\"color:#C6D0F5\">model_name\u003C/span>\u003Cspan style=\"color:#949CBB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#C6D0F5\">tuned_model \u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#C6D0F5\"> PeftModel\u003C/span>\u003Cspan style=\"color:#949CBB\">.\u003C/span>\u003Cspan style=\"color:#8CAAEE\">from_pretrained\u003C/span>\u003Cspan style=\"color:#949CBB\">(\u003C/span>\u003Cspan style=\"color:#C6D0F5\">base_model\u003C/span>\u003Cspan style=\"color:#949CBB\">,\u003C/span>\u003Cspan style=\"color:#A6D189\"> \"./lora_model/cprogram/12/\"\u003C/span>\u003Cspan style=\"color:#949CBB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#C6D0F5\">merge_model \u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#C6D0F5\"> tuned_model\u003C/span>\u003Cspan style=\"color:#949CBB\">.\u003C/span>\u003Cspan style=\"color:#8CAAEE\">merge_and_unload\u003C/span>\u003Cspan style=\"color:#949CBB\">()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#C6D0F5\">merge_model\u003C/span>\u003Cspan style=\"color:#949CBB\">.\u003C/span>\u003Cspan style=\"color:#8CAAEE\">save_pretrained\u003C/span>\u003Cspan style=\"color:#949CBB\">(\u003C/span>\u003Cspan style=\"color:#A6D189\">\"./tuned_merge_model/cprogram/12/\"\u003C/span>\u003Cspan style=\"color:#949CBB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#C6D0F5\">merge_model \u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#C6D0F5\"> AutoModelForCausalLM\u003C/span>\u003Cspan style=\"color:#949CBB\">.\u003C/span>\u003Cspan style=\"color:#8CAAEE\">from_pretrained\u003C/span>\u003Cspan style=\"color:#949CBB\">(\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#A6D189\">    \"./tuned_merge_model/cprogram/12/\"\u003C/span>\u003Cspan style=\"color:#949CBB\">,\u003C/span>\u003Cspan style=\"color:#EA999C;font-style:italic\"> device_map\u003C/span>\u003Cspan style=\"color:#81C8BE\">=\u003C/span>\u003Cspan style=\"color:#A6D189\">\"cuda\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#949CBB\">)\u003C/span>\u003C/span>\u003C/code>\u003C/pre>",{"headings":136,"localImagePaths":165,"remoteImagePaths":166,"frontmatter":123,"imagePaths":167},[137,139,142,145,147,150,153,156,159,162],{"depth":30,"slug":138,"text":138},"安装所需要的库",{"depth":30,"slug":140,"text":141},"1-加载数据集","1. 加载数据集",{"depth":30,"slug":143,"text":144},"2-加载训练模型","2. 加载训练模型",{"depth":37,"slug":146,"text":146},"目标模块说明",{"depth":30,"slug":148,"text":149},"3-分词处理","3. 分词处理",{"depth":30,"slug":151,"text":152},"4-应用分词并划分训练集和数据集","4. 应用分词并划分训练集和数据集",{"depth":30,"slug":154,"text":155},"5-配置训练超参数","5. 配置训练超参数",{"depth":30,"slug":157,"text":158},"6-定义训练器","6. 定义训练器",{"depth":30,"slug":160,"text":161},"7-开始训练","7. 开始训练",{"depth":30,"slug":163,"text":164},"8-保存训练模型","8. 保存训练模型",[],[],[],"unsloth-fine-tune-deepseekqwen1-5b.md","note",["Map",171,172],"welcome",{"id":171,"data":173,"body":177,"filePath":178,"digest":179,"rendered":180,"legacyId":187},{"title":174,"description":175,"publishDate":176},"Hello, Welcome","An introduction to using the note feature in Astro Citrus",["Date","2022-07-01T15:20:23.000Z"],"你好， 这是我首次完成的note笔记","src/content/note/welcome.md","0e462b6be32f95e2",{"html":181,"metadata":182},"\u003Cp>你好， 这是我首次完成的note笔记\u003C/p>",{"headings":183,"localImagePaths":184,"remoteImagePaths":185,"frontmatter":173,"imagePaths":186},[],[],[],[],"welcome.md"]